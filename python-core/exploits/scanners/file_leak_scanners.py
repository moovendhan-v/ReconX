#!/usr/bin/env python3
"""
File Leak and Config Scanners - Part 4
Scanners for configuration file leaks and sensitive data exposure
"""

import requests
from typing import Tuple
from urllib.parse import urljoin
from requests.packages.urllib3.exceptions import InsecureRequestWarning

requests.packages.urllib3.disable_warnings(InsecureRequestWarning)


class FileLeakScanner:
    """Base scanner for file leak detection"""
    
    def __init__(self, target: str, timeout: int = 10):
        self.target = target if target.startswith('http') else f"https://{target}"
        self.timeout = timeout
        self.session = requests.Session()


class AppspecYamlLeakScanner(FileLeakScanner):
    """AWS CodeDeploy appspec.yaml leak scanner"""
    
    def scan(self) -> Tuple[bool, str]:
        files = ['/appspec.yaml', '/appspec.yml', '/.appspec.yaml']
        for file in files:
            try:
                url = urljoin(self.target, file)
                resp = self.session.get(url, timeout=self.timeout, verify=False)
                if resp.status_code == 200 and ('version' in resp.text or 'hooks' in resp.text):
                    return True, f"appspec.yaml leak found at {file}"
            except:
                pass
        return False, "No appspec.yaml leaks"


class BehatConfigLeakScanner(FileLeakScanner):
    """Behat config file leak scanner"""
    
    def scan(self) -> Tuple[bool, str]:
        files = ['/behat.yml', '/behat.yml.dist', '/config/behat.yml']
        for file in files:
            try:
                url = urljoin(self.target, file)
                resp = self.session.get(url, timeout=self.timeout, verify=False)
                if resp.status_code == 200 and 'behat' in resp.text.lower():
                    return True, f"Behat config leak found at {file}"
            except:
                pass
        return False, "No Behat config leaks"


class LaravelIgnitionRxssScanner(FileLeakScanner):
    """Laravel Ignition Reflected XSS Scanner"""
    
    def scan(self) -> Tuple[bool, str]:
        paths = ['/_ignition/execute-solution', '/_ignition/health-check']
        for path in paths:
            try:
                url = urljoin(self.target, path)
                resp = self.session.get(url, timeout=self.timeout, verify=False)
                if 'ignition' in resp.text.lower() or resp.status_code == 200:
                    return True, "Laravel Ignition endpoint detected"
            except:
                pass
        return False, "Laravel Ignition not detected"


class CitrixNetscalerMemoryLeakScanner(FileLeakScanner):
    """Citrix NetScaler Memory Leak Scanner (CVE-2023-4966 - Citrix Bleed)"""
    
    def scan(self) -> Tuple[bool, str]:
        paths = ['/vpn/index.html', '/logon/LogonPoint/index.html']
        for path in paths:
            try:
                url = urljoin(self.target, path)
                resp = self.session.get(url, timeout=self.timeout, verify=False)
                if 'citrix' in resp.text.lower() or 'netscaler' in resp.text.lower():
                    return True, "Citrix NetScaler Gateway detected"
            except:
                pass
        return False, "Citrix not detected"


class DotEnvFileLeakScanner(FileLeakScanner):
    """.env file leak scanner"""
    
    def scan(self) -> Tuple[bool, str]:
        files = ['/.env', '/.env.local', '/.env.production', '/.env.development', '/.env.backup']
        for file in files:
            try:
                url = urljoin(self.target, file)
                resp = self.session.get(url, timeout=self.timeout, verify=False)
                if resp.status_code == 200 and ('=' in resp.text or 'APP_' in resp.text or 'DB_' in resp.text):
                    return True, f".env file leak found at {file}"
            except:
                pass
        return False, "No .env file leaks"


class GitConfigLeakScanner(FileLeakScanner):
    """.git directory leak scanner"""
    
    def scan(self) -> Tuple[bool, str]:
        files = ['/.git/config', '/.git/HEAD', '/.git/index']
        for file in files:
            try:
                url = urljoin(self.target, file)
                resp = self.session.get(url, timeout=self.timeout, verify=False)
                if resp.status_code == 200 and len(resp.text) > 0:
                    return True, f".git directory exposed at {file}"
            except:
                pass
        return False, "No .git exposure"


class DockerfileLeakScanner(FileLeakScanner):
    """Dockerfile leak scanner"""
    
    def scan(self) -> Tuple[bool, str]:
        files = ['/Dockerfile', '/docker-compose.yml', '/docker-compose.yaml', '/.dockerignore']
        for file in files:
            try:
                url = urljoin(self.target, file)
                resp = self.session.get(url, timeout=self.timeout, verify=False)
                if resp.status_code == 200 and ('FROM' in resp.text or 'version' in resp.text):
                    return True, f"Docker config leak found at {file}"
            except:
                pass
        return False, "No Docker config leaks"


class BackupFileLeakScanner(FileLeakScanner):
    """Backup file leak scanner"""
    
    def scan(self) -> Tuple[bool, str]:
        extensions = ['.bak', '.backup', '.old', '.sql', '.zip', '.tar.gz']
        common_names = ['backup', 'database', 'db', 'dump', 'site']
        
        for name in common_names:
            for ext in extensions:
                try:
                    url = urljoin(self.target, f"/{name}{ext}")
                    resp = self.session.head(url, timeout=self.timeout, verify=False)
                    if resp.status_code == 200:
                        return True, f"Backup file found: {name}{ext}"
                except:
                    pass
        return False, "No backup files exposed"


class ConfigFileLeakScanner(FileLeakScanner):
    """Configuration file leak scanner"""
    
    def scan(self) -> Tuple[bool, str]:
        files = ['/config.php', '/configuration.php', '/wp-config.php', '/config.yml', 
                 '/settings.php', '/parameters.yml', '/database.yml']
        for file in files:
            try:
                url = urljoin(self.target, file)
                resp = self.session.get(url, timeout=self.timeout, verify=False)
                if resp.status_code == 200 and ('password' in resp.text.lower() or 'database' in resp.text.lower()):
                    return True, f"Config file leak found at {file}"
            except:
                pass
        return False, "No config file leaks"


class RobotsTxtInfoLeakScanner(FileLeakScanner):
    """robots.txt information disclosure scanner"""
    
    def scan(self) -> Tuple[bool, str]:
        try:
            url = urljoin(self.target, '/robots.txt')
            resp = self.session.get(url, timeout=self.timeout, verify=False)
            if resp.status_code == 200 and 'Disallow' in resp.text:
                disallows = [line for line in resp.text.split('\n') if 'Disallow' in line]
                if len(disallows) > 5:
                    return True, f"robots.txt found with {len(disallows)} disallowed paths"
        except:
            pass
        return False, "No interesting robots.txt"


# Export all
__all__ = [
    'AppspecYamlLeakScanner', 'BehatConfigLeakScanner', 'LaravelIgnitionRxssScanner',
    'CitrixNetscalerMemoryLeakScanner', 'DotEnvFileLeakScanner', 'GitConfigLeakScanner',
    'DockerfileLeakScanner', 'BackupFileLeakScanner', 'ConfigFileLeakScanner',
    'RobotsTxtInfoLeakScanner',
]
