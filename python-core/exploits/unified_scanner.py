#!/usr/bin/env python3
"""
ReconX Unified Vulnerability Scanner
Aggregates all CVE scanners into a single CLI tool
"""

import argparse
import sys
from pathlib import Path
from typing import Dict, List

sys.path.insert(0, str(Path(__file__).parent.parent))
from shared import Theme, Signature, BannerDisplay

# Import all scanner modules  
from scanners.multi_cve_scanner import (
    CVE_2021_42063_Scanner, CVE_2018_8033_Scanner, CVE_2023_27524_Scanner,
    PHPInfoLeakScanner, ShellHistoryLeakScanner, CRLFInjectionScanner, OpenRedirectScanner
)
from scanners.extended_scanners import *
from scanners.additional_scanners import *
from scanners.file_leak_scanners import *


ALL_SCANNERS = {
    # From multi_cve_scanner.py
    'CVE-2021-42063': CVE_2021_42063_Scanner,
    'CVE-2018-8033': CVE_2018_8033_Scanner,
    'CVE-2023-27524': CVE_2023_27524_Scanner,
    'phpinfo-files-leaks': PHPInfoLeakScanner,
    'shell-history-leaks': ShellHistoryLeakScanner,
    'crlfi': CRLFInjectionScanner,
    'Open redirect': OpenRedirectScanner,
    
    # Network Device CVEs
    'CVE-2020-3187': CVE_2020_3187_Scanner,
    'CVE-2020-3452': CVE_2020_3452_Scanner,
    'CVE-2023-24044': CVE_2023_24044_Scanner,
    'CVE-2024-24919': CVE_2024_24919_Scanner,
    'CVE-2018-0296': CVE_2018_0296_Scanner,
    
    # Enterprise App CVEs
    'CVE-2021-20323': CVE_2021_20323_Scanner,
    'CVE-2023-29489': CVE_2023_29489_Scanner,
    'CVE-2019-9670': CVE_2019_9670_Scanner,
    'CVE-2020-27838': CVE_2020_27838_Scanner,
    'CVE-2021-40438': CVE_2021_40438_Scanner,
    'CVE-2021-24917': CVE_2021_24917_Scanner,
    
    # Legacy CVEs
    'CVE-2017-7269': CVE_2017_7269_Scanner,
    'CVE-2015-1635': CVE_2015_1635_Scanner,
    'CVE-2015-7297': CVE_2015_7297_Scanner,
    'CVE-2000-0114': CVE_2000_0114_Scanner,
    'CVE-2018-11784': CVE_2018_11784_Scanner,
    
    # Specialized CVEs
    'CVE-2022-0165': CVE_2022_0165_Scanner,
    'CVE-2024-1208': CVE_2024_1208_Scanner,
    'CVE-2023-46805': CVE_2023_46805_Scanner,
    'CVE-2019-12616': CVE_2019_12616_Scanner,
    'CVE-2024-4956': CVE_2024_4956_Scanner,
    'CVE-2020-35489': CVE_2020_35489_Scanner,
    'CVE-2023-4568': CVE_2023_4568_Scanner,
    'CVE-2023-5089': CVE_2023_5089_Scanner,
    
    # File Leak Scanners
    'appspec-yaml-leaks': AppspecYamlLeakScanner,
    'behat-config-leaks': BehatConfigLeakScanner,
    'laravel-ignition-Rxss': LaravelIgnitionRxssScanner,
    'citrix-netscaler-memory-leak': CitrixNetscalerMemoryLeakScanner,
    '.env-leaks': DotEnvFileLeakScanner,
    '.git-exposure': GitConfigLeakScanner,
    'dockerfile-leaks': DockerfileLeakScanner,
    'backup-file-leaks': BackupFileLeakScanner,
    'config-file-leaks': ConfigFileLeakScanner,
    'robots-txt-info': RobotsTxtInfoLeakScanner,
}


def run_single_scan(scanner_name: str, target: str) -> tuple:
    """Run a single scanner"""
    if scanner_name not in ALL_SCANNERS:
        return False, f"Scanner '{scanner_name}' not found"
    
    scanner_class = ALL_SCANNERS[scanner_name]
    scanner = scanner_class(target)
    return scanner.scan()


def run_all_scans(target: str) -> Dict[str, tuple]:
    """Run all scanners against target"""
    results = {}
    for name, scanner_class in ALL_SCANNERS.items():
        try:
            scanner = scanner_class(target)
            vulnerable, message = scanner.scan()
            results[name] = (vulnerable, message)
        except Exception as e:
            results[name] = (False, f"Error: {str(e)}")
    return results


def main():
    sig = Signature(
        tool_name="ReconX Unified Scanner",
        version="2.0",
        exploit_name="MegaScanner"
    )
    
    display = BannerDisplay(sig)
    display.show_header("""
█▀▄▀█ ██▀ ▄▀  ▄▀▄   ▄▀▀ ▄▀▀ ▄▀▄ █▄ █ █▄ █ ██▀ █▀▄
█ ▀ █ █▄▄ ▀▄█ █▀█   ▄██ ▀▄▄ █▀█ █ ▀█ █ ▀█ █▄▄ █▀▄
    """)
    
    parser = argparse.ArgumentParser(
        description='ReconX Unified Vulnerability Scanner - 37+ CVE Detectors',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog=f"""
Available Scanners ({len(ALL_SCANNERS)}):
  Network Devices: CVE-2020-3187, CVE-2020-3452, CVE-2023-24044, CVE-2024-24919, CVE-2018-0296
  Enterprise Apps: CVE-2021-20323, CVE-2023-29489, CVE-2019-9670, CVE-2021-40438, CVE-2021-24917
  Legacy Systems: CVE-2017-7269, CVE-2015-1635, CVE-2015-7297, CVE-2000-0114, CVE-2018-11784
  Specialized: CVE-2022-0165, CVE-2024-1208, CVE-2023-46805, CVE-2019-12616, CVE-2024-4956
  File Leaks: appspec-yaml, behat-config, .env, .git, dockerfile, backups, configs
  
Examples:
  # Scan all CVEs
  scanner.py -t https://target.com --all
  
  # Scan specific CVE
  scanner.py -t https://target.com -s CVE-2023-24044
  
  # Scan multiple targets
  scanner.py -l targets.txt --all
  
{sig.get_footer()}
        """
    )
    
    parser.add_argument('-t', '--target', help='Single target URL')
    parser.add_argument('-l', '--list', help='File containing list of targets')
    parser.add_argument('-s', '--scanner', help='Specific scanner to run')
    parser.add_argument('-a', '--all', action='store_true', help='Run all scanners')
    parser.add_argument('--format', choices=['text', 'json'], default='text', help='Output format')
    
    args = parser.parse_args()
    
    if not args.target and not args.list:
        parser.print_help()
        sys.exit(1)
    
    targets = []
    if args.target:
        targets = [args.target]
    elif args.list:
        with open(args.list, 'r') as f:
            targets = [line.strip() for line in f if line.strip()]
    
    for target in targets:
        print(f"\n{Theme.HEADER}{'='*60}{Theme.ENDC}")
        print(f"{Theme.OKBLUE}Target: {target}{Theme.ENDC}")
        print(f"{Theme.HEADER}{'='*60}{Theme.ENDC}\n")
        
        if args.all:
            results = run_all_scans(target)
            vulnerable_count = sum(1 for v, _ in results.values() if v)
            
            for name, (vulnerable, message) in results.items():
                status = f"{Theme.FAIL}[VULNERABLE]" if vulnerable else f"{Theme.OKGREEN}[SAFE]"
                print(f"{status} {name:30s} - {message}{Theme.ENDC}")
            
            print(f"\n{Theme.WARNING}Summary: {vulnerable_count}/{len(results)} potential vulnerabilities detected{Theme.ENDC}")
            
        elif args.scanner:
            vulnerable, message = run_single_scan(args.scanner, target)
            if vulnerable:
                print(f"{Theme.FAIL}[VULNERABLE] {message}{Theme.ENDC}")
                sys.exit(1)
            else:
                print(f"{Theme.OKGREEN}[SAFE] {message}{Theme.ENDC}")
                sys.exit(0)


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print(f"\n{Theme.WARNING}[!] Scan interrupted{Theme.ENDC}\n")
        sys.exit(130)
    except Exception as e:
        print(f"\n{Theme.FAIL}[!] Error: {e}{Theme.ENDC}\n")
        import traceback
        traceback.print_exc()
        sys.exit(1)
