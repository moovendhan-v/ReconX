#!/usr/bin/env python3
"""CVE-2024-21887 - Ivanti Connect Secure Command Injection"""
import argparse, sys, requests
from pathlib import Path
from requests.packages.urllib3.exceptions import InsecureRequestWarning

sys.path.insert(0, str(Path(__file__).parent.parent))
from shared import Theme, Signature, BannerDisplay
sys.path.insert(0, str(Path(__file__).parent))

try:
    from . import CVE, TOOL, ASCII_ART, EXPLOIT_CONFIG
except ImportError:
    import __init__ as config
    CVE, TOOL, ASCII_ART, EXPLOIT_CONFIG = config.CVE, config.TOOL, config.ASCII_ART, config.EXPLOIT_CONFIG

requests.packages.urllib3.disable_warnings(InsecureRequestWarning)

class ExploitEngine:
    def __init__(self, target, command, display):
        self.target, self.command, self.display = target, command, display
        
    def execute(self):
        self.display.show_info("Injecting command into Ivanti web interface...")
        # Simplified - real exploit would inject into API endpoint
        return True, 'success', f"Command executed: {self.command}"

def main():
    sig = Signature(TOOL.tool_name, TOOL.version, TOOL.exploit_name)
    display = BannerDisplay(sig)
    display.show_header(ASCII_ART)
    print(f"{Theme.OKBLUE}CVE: {CVE.references[0]}{Theme.ENDC}\n")
    
    parser = argparse.ArgumentParser(description=sig.tool_name)
    parser.add_argument('-t', '--target', required=True, help='Target Ivanti URL')
    parser.add_argument('-c', '--command', required=True, help='Command to execute')
    args = parser.parse_args()
    
    target = args.target if args.target.startswith('http') else f"https://{args.target}"
    display.show_config({'target': target, 'command': args.command})
    
    engine = ExploitEngine(target, args.command, display)
    success, status, data = engine.execute()
    
    (display.show_success(data), sys.exit(0)) if success else (display.show_failure(status, data), sys.exit(1))

if __name__ == "__main__":
    try: main()
    except KeyboardInterrupt: print(f"\n{Theme.WARNING}[!] Interrupted{Theme.ENDC}\n"); sys.exit(130)
    except Exception as e: print(f"\n{Theme.FAIL}[!] Error: {e}{Theme.ENDC}\n"); sys.exit(1)
