#!/usr/bin/env python3
"""
Bug Hunting Platform - Exploit Orchestrator
Main entry point for discovering and executing POC exploits

This script automatically discovers all available exploits, displays their metadata,
and provides an interactive interface for execution.

Author: Moovendhan V
Website: www.cybertechmind.com
"""

import sys
import importlib
import subprocess
from pathlib import Path
from typing import List, Dict, Any
from datetime import datetime

# Add current directory to path
sys.path.insert(0, str(Path(__file__).parent))

try:
    from shared import Theme, Signature, BannerDisplay
except ImportError:
    print("Error: Shared utilities not found. Please ensure exploits/shared/ exists.")
    sys.exit(1)


class ExploitDiscovery:
    """Auto-discovers and loads exploit configurations"""
    
    def __init__(self, exploits_dir: Path):
        self.exploits_dir = exploits_dir
        self.exploits = []
        
    def discover_exploits(self) -> List[Dict[str, Any]]:
        """Discover all CVE exploit directories and load their configurations"""
        exploits = []
        
        # Find all CVE directories
        for cve_dir in self.exploits_dir.iterdir():
            if not cve_dir.is_dir():
                continue
            
            # Skip special directories
            if cve_dir.name in ['shared', '__pycache__']:
                continue
            
            # Check if it has __init__.py (configuration)
            config_file = cve_dir / '__init__.py'
            if not config_file.exists():
                continue
            
            # Try to load configuration
            try:
                config = self._load_config(cve_dir.name)
                if config:
                    exploits.append(config)
            except Exception as e:
                print(f"{Theme.WARNING}Warning: Failed to load {cve_dir.name}: {e}{Theme.ENDC}")
                continue
        
        # Sort by CVE ID
        exploits.sort(key=lambda x: x.get('cve_id', ''))
        self.exploits = exploits
        return exploits
    
    def _load_config(self, module_name: str) -> Dict[str, Any]:
        """Load exploit configuration from module"""
        try:
            # Import the module
            module = importlib.import_module(module_name)
            
            # Get configuration
            cve = getattr(module, 'CVE', None)
            tool = getattr(module, 'TOOL', None)
            poc_meta = getattr(module, 'POC_METADATA', None)
            
            if not cve or not tool:
                return None
            
            # Find exploit script
            exploit_path = self.exploits_dir / module_name / 'exploit.py'
            
            return {
                'module': module_name,
                'cve_id': cve.cve_id,
                'title': cve.title,
                'severity': cve.severity,
                'cvss_score': cve.cvss_score,
                'description': cve.description,
                'tool_name': tool.tool_name,
                'exploit_name': tool.exploit_name,
                'author': tool.author,
                'version': tool.version,
                'language': tool.language,
                'exploit_path': str(exploit_path),
                'affected_products': getattr(cve, 'affected_products', []),
                'published_date': getattr(cve, 'published_date', None),
                'poc_name': poc_meta.get('name', '') if poc_meta else '',
            }
        except Exception as e:
            print(f"{Theme.DIM}Debug: Error loading {module_name}: {e}{Theme.ENDC}")
            return None


class ExploitOrchestrator:
    """Main orchestrator for exploit management and execution"""
    
    def __init__(self):
        self.exploits_dir = Path(__file__).parent
        self.discovery = ExploitDiscovery(self.exploits_dir)
        self.exploits = []
        
        # Initialize signature
        self.signature = Signature(
            tool_name="Bug Hunting Platform - Exploit Orchestrator",
            version="1.0",
            exploit_name="ExploitHub"
        )
        self.display = BannerDisplay(self.signature)
    
    def show_banner(self):
        """Display main banner"""
        ascii_art = """
██████╗ ██╗   ██╗ ██████╗     ██╗  ██╗██╗   ██╗███╗   ██╗████████╗
██╔══██╗██║   ██║██╔════╝     ██║  ██║██║   ██║████╗  ██║╚══██╔══╝
██████╔╝██║   ██║██║  ███╗    ███████║██║   ██║██╔██╗ ██║   ██║   
██╔══██╗██║   ██║██║   ██║    ██╔══██║██║   ██║██║╚██╗██║   ██║   
██████╔╝╚██████╔╝╚██████╔╝    ██║  ██║╚██████╔╝██║ ╚████║   ██║   
╚═════╝  ╚═════╝  ╚═════╝     ╚═╝  ╚═╝ ╚═════╝ ╚═╝  ╚═══╝   ╚═╝   
                                                                    
        """
        self.display.show_header(ascii_art)
        print(f"{Theme.OKCYAN}POC Exploit Discovery & Execution Platform{Theme.ENDC}\n")
    
    def list_exploits(self):
        """Display all discovered exploits"""
        if not self.exploits:
            print(f"{Theme.WARNING}No exploits found.{Theme.ENDC}\n")
            return
        
        print(f"{Theme.OKBLUE}{Theme.BOLD}Available Exploits:{Theme.ENDC}")
        print(f"{Theme.DIM}{'─' * 90}{Theme.ENDC}\n")
        
        for idx, exploit in enumerate(self.exploits, 1):
            severity_colors = {
                'LOW': Theme.OKBLUE,
                'MEDIUM': Theme.WARNING,
                'HIGH': Theme.FAIL,
                'CRITICAL': f"{Theme.FAIL}{Theme.BOLD}"
            }
            severity_color = severity_colors.get(exploit['severity'], Theme.ENDC)
            
            print(f"{Theme.BOLD}[{idx}] {exploit['cve_id']}{Theme.ENDC} - {exploit['exploit_name']}")
            print(f"    {Theme.DIM}Title:{Theme.ENDC} {exploit['title']}")
            print(f"    {Theme.DIM}Severity:{Theme.ENDC} {severity_color}{exploit['severity']}{Theme.ENDC} "
                  f"({Theme.OKCYAN}CVSS: {exploit['cvss_score']}{Theme.ENDC})")
            print(f"    {Theme.DIM}Author:{Theme.ENDC} {exploit['author']}")
            print(f"    {Theme.DIM}Language:{Theme.ENDC} {exploit['language']}")
            
            if exploit['affected_products']:
                products = ', '.join(exploit['affected_products'][:3])
                if len(exploit['affected_products']) > 3:
                    products += f" (+{len(exploit['affected_products']) - 3} more)"
                print(f"    {Theme.DIM}Affects:{Theme.ENDC} {products}")
            
            print()
        
        print(f"{Theme.DIM}{'─' * 90}{Theme.ENDC}")
    
    def show_exploit_detail(self, index: int):
        """Show detailed information about a specific exploit"""
        if index < 1 or index > len(self.exploits):
            print(f"{Theme.FAIL}Invalid exploit number.{Theme.ENDC}\n")
            return
        
        exploit = self.exploits[index - 1]
        
        print(f"\n{Theme.OKBLUE}{Theme.BOLD}Exploit Details:{Theme.ENDC}")
        print(f"{Theme.DIM}{'─' * 90}{Theme.ENDC}")
        print(f"{Theme.BOLD}CVE ID:{Theme.ENDC} {exploit['cve_id']}")
        print(f"{Theme.BOLD}Title:{Theme.ENDC} {exploit['title']}")
        print(f"{Theme.BOLD}Severity:{Theme.ENDC} {exploit['severity']} (CVSS: {exploit['cvss_score']})")
        print(f"\n{Theme.BOLD}Description:{Theme.ENDC}")
        print(f"{exploit['description']}\n")
        print(f"{Theme.BOLD}Tool:{Theme.ENDC} {exploit['tool_name']} v{exploit['version']}")
        print(f"{Theme.BOLD}Exploit Name:{Theme.ENDC} {exploit['exploit_name']}")
        print(f"{Theme.BOLD}Author:{Theme.ENDC} {exploit['author']}")
        print(f"{Theme.BOLD}Language:{Theme.ENDC} {exploit['language']}")
        
        if exploit['affected_products']:
            print(f"\n{Theme.BOLD}Affected Products:{Theme.ENDC}")
            for product in exploit['affected_products']:
                print(f"  • {product}")
        
        if exploit['published_date']:
            print(f"\n{Theme.BOLD}Published:{Theme.ENDC} {exploit['published_date'].strftime('%Y-%m-%d')}")
        
        print(f"\n{Theme.BOLD}Script Path:{Theme.ENDC} {exploit['exploit_path']}")
        print(f"{Theme.DIM}{'─' * 90}{Theme.ENDC}\n")
    
    def execute_exploit(self, index: int, args: List[str] = None):
        """Execute a specific exploit with given arguments"""
        if index < 1 or index > len(self.exploits):
            print(f"{Theme.FAIL}Invalid exploit number.{Theme.ENDC}\n")
            return
        
        exploit = self.exploits[index - 1]
        exploit_path = Path(exploit['exploit_path'])
        
        if not exploit_path.exists():
            print(f"{Theme.FAIL}Error: Exploit script not found at {exploit_path}{Theme.ENDC}\n")
            return
        
        print(f"{Theme.OKCYAN}Executing: {exploit['exploit_name']} ({exploit['cve_id']}){Theme.ENDC}\n")
        
        # Build command
        cmd = [sys.executable, str(exploit_path)]
        if args:
            cmd.extend(args)
        else:
            # Show help if no args
            cmd.append('--help')
        
        try:
            # Execute
            result = subprocess.run(cmd, cwd=exploit_path.parent)
            
            if result.returncode == 0:
                print(f"\n{Theme.OKGREEN}Exploit executed successfully.{Theme.ENDC}\n")
            else:
                print(f"\n{Theme.WARNING}Exploit exited with code {result.returncode}.{Theme.ENDC}\n")
        
        except KeyboardInterrupt:
            print(f"\n{Theme.WARNING}Execution interrupted by user.{Theme.ENDC}\n")
        except Exception as e:
            print(f"\n{Theme.FAIL}Error executing exploit: {e}{Theme.ENDC}\n")
    
    def interactive_mode(self):
        """Run interactive selection mode"""
        while True:
            print(f"\n{Theme.OKBLUE}Select an option:{Theme.ENDC}")
            print(f"  {Theme.BOLD}l{Theme.ENDC} - List all exploits")
            print(f"  {Theme.BOLD}d <num>{Theme.ENDC} - Show exploit details (e.g., 'd 1')")
            print(f"  {Theme.BOLD}r <num>{Theme.ENDC} - Run exploit (e.g., 'r 1')")
            print(f"  {Theme.BOLD}h{Theme.ENDC} - Show this help")
            print(f"  {Theme.BOLD}q{Theme.ENDC} - Quit")
            
            try:
                choice = input(f"\n{Theme.OKCYAN}>{Theme.ENDC} ").strip().lower()
                
                if not choice:
                    continue
                
                if choice == 'q':
                    print(f"\n{Theme.OKGREEN}Goodbye!{Theme.ENDC}\n")
                    break
                
                elif choice == 'l':
                    self.list_exploits()
                
                elif choice == 'h':
                    continue
                
                elif choice.startswith('d '):
                    try:
                        num = int(choice.split()[1])
                        self.show_exploit_detail(num)
                    except (ValueError, IndexError):
                        print(f"{Theme.FAIL}Invalid format. Use: d <number>{Theme.ENDC}")
                
                elif choice.startswith('r '):
                    parts = choice.split(maxsplit=1)
                    try:
                        num = int(parts[0].split()[1])
                        # Get additional args if provided
                        remaining = parts[1] if len(parts) > 1 else ''
                        args = remaining.split() if remaining else None
                        self.execute_exploit(num, args)
                    except (ValueError, IndexError):
                        print(f"{Theme.FAIL}Invalid format. Use: r <number> [args]{Theme.ENDC}")
                
                else:
                    print(f"{Theme.WARNING}Unknown command. Type 'h' for help.{Theme.ENDC}")
            
            except KeyboardInterrupt:
                print(f"\n{Theme.WARNING}Use 'q' to quit.{Theme.ENDC}")
            except EOFError:
                break
    
    def run(self, args: List[str] = None):
        """Main execution flow"""
        self.show_banner()
        
        # Discover exploits
        print(f"{Theme.OKCYAN}Discovering exploits...{Theme.ENDC}")
        self.exploits = self.discovery.discover_exploits()
        print(f"{Theme.OKGREEN}Found {len(self.exploits)} exploit(s).{Theme.ENDC}\n")
        
        if not self.exploits:
            print(f"{Theme.WARNING}No exploits found in {self.exploits_dir}{Theme.ENDC}")
            print(f"{Theme.DIM}Ensure CVE directories have __init__.py configuration files.{Theme.ENDC}\n")
            return
        
        # Check for command line args
        if args and len(args) > 0:
            # Direct execution mode
            if args[0] == 'list':
                self.list_exploits()
            elif args[0] == 'info' and len(args) > 1:
                try:
                    num = int(args[1])
                    self.show_exploit_detail(num)
                except ValueError:
                    print(f"{Theme.FAIL}Invalid exploit number.{Theme.ENDC}")
            elif args[0] == 'run' and len(args) > 1:
                try:
                    num = int(args[1])
                    exploit_args = args[2:] if len(args) > 2 else None
                    self.execute_exploit(num, exploit_args)
                except ValueError:
                    print(f"{Theme.FAIL}Invalid exploit number.{Theme.ENDC}")
            else:
                print(f"{Theme.FAIL}Unknown command: {args[0]}{Theme.ENDC}")
                print(f"\nUsage: script.py [list|info <num>|run <num> [args]]")
        else:
            # Interactive mode
            self.list_exploits()
            self.interactive_mode()


def main():
    """Entry point"""
    try:
        orchestrator = ExploitOrchestrator()
        orchestrator.run(sys.argv[1:])
    except KeyboardInterrupt:
        print(f"\n{Theme.WARNING}Interrupted by user.{Theme.ENDC}\n")
        sys.exit(130)
    except Exception as e:
        print(f"\n{Theme.FAIL}Fatal error: {e}{Theme.ENDC}\n")
        sys.exit(1)


if __name__ == "__main__":
    main()
