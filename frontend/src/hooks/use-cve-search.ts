import { useState, useEffect, useCallback } from 'react';
import { useQuery } from '@apollo/client/react';
import { GET_CVES } from '../graphql/queries/cve.queries';

interface CVE {
    id: string;
    cveId: string;
    title: string;
    severity: string;
}

interface CVESearchResult {
    cves: CVE[];
    total: number;
    loading: boolean;
    error: string | null;
    loadMore: () => void;
    hasMore: boolean;
}

interface UseCVESearchOptions {
    search?: string;
    limit?: number;
}

export function useCVESearch(options: UseCVESearchOptions = {}): CVESearchResult {
    const { search = '', limit = 20 } = options;
    const [page, setPage] = useState(1);
    const [allCVEs, setAllCVEs] = useState<CVE[]>([]);

    const { data, loading, error, fetchMore } = useQuery(GET_CVES, {
        variables: {
            filters: {
                search: search || undefined,
                limit,
                page: 1,
            },
        },
        notifyOnNetworkStatusChange: true,
    });

    // Reset when search changes
    useEffect(() => {
        setPage(1);
        setAllCVEs([]);
    }, [search]);

    // Update CVEs when data changes
    useEffect(() => {
        if (data?.cves?.cves) {
            if (page === 1) {
                setAllCVEs(data.cves.cves);
            } else {
                setAllCVEs((prev) => [...prev, ...data.cves.cves]);
            }
        }
    }, [data, page]);

    const loadMore = useCallback(() => {
        if (loading || !data?.cves) return;

        const nextPage = page + 1;
        setPage(nextPage);

        fetchMore({
            variables: {
                filters: {
                    search: search || undefined,
                    limit,
                    page: nextPage,
                },
            },
        });
    }, [loading, data, page, limit, search, fetchMore]);

    const hasMore = data?.cves ? page < data.cves.totalPages : false;

    return {
        cves: allCVEs,
        total: data?.cves?.total || 0,
        loading,
        error: error?.message || null,
        loadMore,
        hasMore,
    };
}
