import { useQuery, useMutation, useApolloClient } from '@apollo/client/react';
import {
  GET_CVES,
  GET_CVE,
  GET_CVE_WITH_POCS,
  SEARCH_CVES,
  GET_CVE_STATISTICS,
  CREATE_CVE,
  UPDATE_CVE,
  DELETE_CVE
} from '@/graphql/queries/cve.queries';
import { CVEFilters, CVE, CVEStatistics, CreateCVEInput, UpdateCVEInput } from '@/services/graphql/cve.service';

// Type definitions for GraphQL responses
export interface GetCVEsResponse {
  cves: {
    cves: CVE[];
    total: number;
    page: number;
    limit: number;
    totalPages: number;
  };
}

export interface GetCVEResponse {
  cve: CVE;
}

export interface GetCVEWithPOCsResponse {
  cveWithPocs: CVE & {
    pocs: Array<{
      id: string;
      name: string;
      description: string;
      language: string;
      scriptPath: string;
      author: string;
      createdAt: string;
      updatedAt: string;
    }>;
  };
}

export interface GetCVEStatisticsResponse {
  cveStatistics: CVEStatistics;
}

export const useCVEs = (filters?: CVEFilters) => {
  return useQuery<GetCVEsResponse>(GET_CVES, {
    variables: { filters },
    fetchPolicy: 'cache-and-network',
    errorPolicy: 'all',
  });
};

export const useCVE = (id: string) => {
  return useQuery<GetCVEResponse>(GET_CVE, {
    variables: { id },
    fetchPolicy: 'cache-first',
    errorPolicy: 'all',
    skip: !id,
  });
};

export const useCVEWithPOCs = (id: string) => {
  return useQuery<GetCVEWithPOCsResponse>(GET_CVE_WITH_POCS, {
    variables: { id },
    fetchPolicy: 'cache-and-network',
    errorPolicy: 'all',
    skip: !id,
  });
};

export const useSearchCVEs = () => {
  const client = useApolloClient();

  const searchCVEs = async (query: string): Promise<CVE[]> => {
    if (!query.trim()) return [];

    try {
      const { data } = await client.query<{ searchCves: CVE[] }>({
        query: SEARCH_CVES,
        variables: { query },
        fetchPolicy: 'network-only',
      });

      return data?.searchCves || [];
    } catch (error) {
      console.error('Search error:', error);
      return [];
    }
  };

  return { searchCVEs };
};

export const useCVEStatistics = () => {
  return useQuery<GetCVEStatisticsResponse>(GET_CVE_STATISTICS, {
    fetchPolicy: 'cache-and-network',
    errorPolicy: 'all',
    pollInterval: 300000, // Poll every 5 minutes
  });
};

export const useCreateCVE = () => {
  return useMutation<{ createCve: CVE }, { input: CreateCVEInput }>(CREATE_CVE, {
    refetchQueries: [
      { query: GET_CVES },
      { query: GET_CVE_STATISTICS }
    ],
    errorPolicy: 'all',
  });
};

export const useUpdateCVE = () => {
  return useMutation<{ updateCve: CVE }, { id: string; input: UpdateCVEInput }>(UPDATE_CVE, {
    errorPolicy: 'all',
  });
};

export const useDeleteCVE = () => {
  return useMutation<{ deleteCve: boolean }, { id: string }>(DELETE_CVE, {
    refetchQueries: [
      { query: GET_CVES },
      { query: GET_CVE_STATISTICS }
    ],
    errorPolicy: 'all',
  });
};

// Custom hook for CVE management with optimistic updates
export const useCVEOperations = () => {
  const [createCVE, { loading: creating }] = useCreateCVE();
  const [updateCVE, { loading: updating }] = useUpdateCVE();
  const [deleteCVE, { loading: deleting }] = useDeleteCVE();

  const handleCreate = async (input: CreateCVEInput) => {
    try {
      const result = await createCVE({ variables: { input } });
      return result.data?.createCve;
    } catch (error) {
      console.error('Create CVE error:', error);
      throw error;
    }
  };

  const handleUpdate = async (id: string, input: UpdateCVEInput) => {
    try {
      const result = await updateCVE({
        variables: { id, input },
        optimisticResponse: {
          updateCve: {
            id,
            ...input,
            updatedAt: new Date().toISOString(),
          } as CVE,
        },
      });
      return result.data?.updateCve;
    } catch (error) {
      console.error('Update CVE error:', error);
      throw error;
    }
  };

  const handleDelete = async (id: string) => {
    try {
      const result = await deleteCVE({
        variables: { id },
        optimisticResponse: {
          deleteCve: true,
        },
      });
      return result.data?.deleteCve;
    } catch (error) {
      console.error('Delete CVE error:', error);
      throw error;
    }
  };

  return {
    createCVE: handleCreate,
    updateCVE: handleUpdate,
    deleteCVE: handleDelete,
    loading: creating || updating || deleting,
  };
};