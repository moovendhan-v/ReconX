import React, { useState } from 'react';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Checkbox } from '@/components/ui/checkbox';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Loader2, Search } from 'lucide-react';
import type { CVEInput } from '@/services/dynamic-cve.service';

interface DynamicCVEInputRendererProps {
    inputs: CVEInput[];
    cveId: string;
    onInputChange: (name: string, value: any) => void;
    onDiscover?: (cveId: string) => Promise<void>;
    discovering?: boolean;
    discoveredParams?: any;
}

export function DynamicCVEInputRenderer({
    inputs,
    cveId,
    onInputChange,
    onDiscover,
    discovering = false,
    discoveredParams,
}: DynamicCVEInputRendererProps) {
    const [values, setValues] = useState<Record<string, any>>({});

    const handleChange = (name: string, value: any) => {
        setValues(prev => ({ ...prev, [name]: value }));
        onInputChange(name, value);
    };

    const renderInput = (input: CVEInput) => {
        const inputId = `${cveId}-${input.name}`;
        const value = values[input.name] ?? input.default;

        switch (input.type) {
            case 'TEXT':
                return (
                    <div key={input.name} className="space-y-2">
                        <Label htmlFor={inputId}>
                            {input.name}
                            {input.required && <span className="text-destructive ml-1">*</span>}
                        </Label>
                        {input.description && (
                            <p className="text-sm text-muted-foreground">{input.description}</p>
                        )}
                        <Input
                            id={inputId}
                            type="text"
                            placeholder={input.default || `Enter ${input.name}`}
                            value={value || ''}
                            onChange={(e) => handleChange(input.name, e.target.value)}
                            className="font-mono text-sm"
                        />
                    </div>
                );

            case 'BOOLEAN':
                return (
                    <div key={input.name} className="flex items-center space-x-2 py-3">
                        <Checkbox
                            id={inputId}
                            checked={value || false}
                            onCheckedChange={(checked) => handleChange(input.name, checked)}
                        />
                        <div className="space-y-1">
                            <Label htmlFor={inputId} className="cursor-pointer">
                                {input.name}
                                {input.required && <span className="text-destructive ml-1">*</span>}
                            </Label>
                            {input.description && (
                                <p className="text-sm text-muted-foreground">{input.description}</p>
                            )}
                        </div>
                    </div>
                );

            case 'LIST':
                return (
                    <div key={input.name} className="space-y-2">
                        <Label htmlFor={inputId}>
                            {input.name}
                            {input.required && <span className="text-destructive ml-1">*</span>}
                        </Label>
                        {input.description && (
                            <p className="text-sm text-muted-foreground">{input.description}</p>
                        )}
                        <Select
                            value={value || input.default}
                            onValueChange={(val) => handleChange(input.name, val)}
                        >
                            <SelectTrigger>
                                <SelectValue placeholder={`Select ${input.name}`} />
                            </SelectTrigger>
                            <SelectContent>
                                {input.options?.map((option) => (
                                    <SelectItem key={option} value={option}>
                                        {option}
                                    </SelectItem>
                                ))}
                            </SelectContent>
                        </Select>
                    </div>
                );

            case 'AUTO_DISCOVER':
                return (
                    <div key={input.name} className="space-y-3 p-4 border rounded-lg bg-muted/20">
                        <div className="flex items-center justify-between">
                            <div>
                                <Label>{input.name}</Label>
                                {input.description && (
                                    <p className="text-sm text-muted-foreground mt-1">{input.description}</p>
                                )}
                            </div>
                            <Button
                                type="button"
                                variant="secondary"
                                size="sm"
                                onClick={() => onDiscover?.(cveId)}
                                disabled={discovering}
                            >
                                {discovering ? (
                                    <>
                                        <Loader2 className="mr-2 h-4 w-4 animate-spin" />
                                        Discovering...
                                    </>
                                ) : (
                                    <>
                                        <Search className="mr-2 h-4 w-4" />
                                        Auto-Discover
                                    </>
                                )}
                            </Button>
                        </div>

                        {discoveredParams && (
                            <div className="mt-3 space-y-2 text-sm">
                                <div className="font-medium text-green-400">
                                    Found {Object.values(discoveredParams.discovered).flat().length} parameters
                                </div>
                                {Object.entries(discoveredParams.discovered).map(([location, params]: [string, any]) => (
                                    params.length > 0 && (
                                        <div key={location} className="flex gap-2">
                                            <Badge variant="outline" className="capitalize">
                                                {location}
                                            </Badge>
                                            <span className="text-muted-foreground">
                                                {Array.isArray(params) ? params.join(', ') : 'none'}
                                            </span>
                                        </div>
                                    )
                                ))}
                            </div>
                        )}
                    </div>
                );

            default:
                return null;
        }
    };

    // Filter out target_url as it's handled separately
    const displayInputs = inputs.filter(inp => inp.name !== 'target_url');

    if (displayInputs.length === 0) {
        return (
            <div className="text-center py-6 text-muted-foreground">
                No additional inputs required for this CVE
            </div>
        );
    }

    return (
        <div className="space-y-4">
            {displayInputs.map(renderInput)}
        </div>
    );
}
