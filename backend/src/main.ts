import { NestFactory } from '@nestjs/core';
import { ValidationPipe } from '@nestjs/common';
import { SwaggerModule, DocumentBuilder } from '@nestjs/swagger';
import { AppModule } from './app.module';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // Enable CORS for frontend
  app.enableCors({
    origin: '*',
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS', 'HEAD'],
    allowedHeaders: ['Content-Type', 'Authorization', 'Accept', 'X-Requested-With'],
    credentials: true,
    preflightContinue: false,
    optionsSuccessStatus: 204,
  });

  // Global validation pipe
  app.useGlobalPipes(
    new ValidationPipe({
      whitelist: true,
      forbidNonWhitelisted: true,
      transform: true,
    }),
  );

  // Swagger API Documentation
  const config = new DocumentBuilder()
    .setTitle('Bug Hunting Platform API')
    .setDescription('API documentation for Bug Hunting Platform with CVE and POC management')
    .setVersion('1.0')
    .addTag('health', 'Health check endpoints')
    .addTag('cve', 'CVE management')
    .addTag('poc', 'Proof of Concept management')
    .addBearerAuth()
    .build();

  const document = SwaggerModule.createDocument(app, config);
  SwaggerModule.setup('api/docs', app, document);

  const port = process.env.PORT || 3000;
  await app.listen(port);

  console.log(`üöÄ GraphQL API Server running on port ${port}`);
  console.log(`üìç GraphQL Playground: http://localhost:${port}/graphql`);
  console.log(`üìö Swagger API Docs: http://localhost:${port}/api/docs`);
}

bootstrap();